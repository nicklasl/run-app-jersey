<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<title>Overlay Track Data on a Google Map</title>
</head>
<style type="text/css" media="all">
@import "apidemo/garminGpsControlAPIDemo.css";
</style>
<script
	src="http://maps.google.com/maps?file=api&v=2.69&key=ABQIAAAAkOp4960CVjgwg7aH_RVbsBQ8mFNy8mluGNJxasFfpjfy_rK2-hTqlIAT8DmZDqe108rJCva4VdWiGA"
	type="text/javascript">&#160;</script>
<script type="text/javascript"
	src="http://www.garmindeveloper.com/web/communicator-api-0.5/prototype/prototype.js">&#160;</script>
<script type="text/javascript"
	src="http://www.garmindeveloper.com/web/communicator-api-0.5/GarminDevicePlugin.js">&#160;</script>
<script type="text/javascript"
	src="http://www.garmindeveloper.com/web/communicator-api-0.5/GarminDeviceControl.js">&#160;</script>
<script type="text/javascript"
	src="http://www.garmindeveloper.com/web/communicator-api-0.5/GoogleMapController.js">&#160;</script>
<script type="text/javascript">
    var GarminDeviceControlDemo = Class.create();
    GarminDeviceControlDemo.prototype = {

        ////////////////////////////////////////////////////////////////////////
        //prototype constructor method:
        
        initialize: function(statusDiv, mapId) {        
            this.status = $(statusDiv);
            this.mc = new Garmin.MapController(mapId);       
            this.findDevicesButton = $("findDevicesButton");
            this.cancelFindDevicesButton = $("cancelFindDevicesButton");
            this.deviceSelect = $("deviceSelect");
            this.deviceInfo = $("deviceInfoText");
            this.readDataButton = $("readDataButton");
            this.cancelReadDataButton = $("cancelReadDataButton");
            this.readTracksText = $("readTracksText");
            this.readTracksSelect = $("readTracksSelect");
            this.readWaypointsSelect = $("readWaypointsSelect");
            this.progressBar = $("progressBar");
            this.progressBarDisplay = $("progressBarDisplay");
            this.garminController = null;
            this.tracks = null;
            this._intializeController();
            this._setStatus("Plug-in initialized.  Find some devices to get started.");
            this.findDevicesButton.disabled = false;
            this.findDevicesButton.onclick = function() {
                this.findDevicesButton.disabled = true;
                this.cancelFindDevicesButton.disabled = false;
                this.garminController.findDevices();
            }.bind(this)
        },
        
        ////////////////////////////////////////////////////////////////////////
        //Garmin.DeviceControl call-back methods:

        onFinishFindDevices: function(json) {
            this.findDevicesButton.disabled = false;
            this.cancelFindDevicesButton.disabled = true;

            if(json.controller.numDevices==1){
            	console.log('Running my method');
            	this.garminController.readFromDevice();
            }
            
            if(json.controller.numDevices > 0) {
                var devices = json.controller.getDevices();
                this._setStatus("Found " + devices.length + " devices.");

                this._listDevices(devices);
                        
                this.cancelReadDataButton.onclick = function() {
                    this.readDataButton.disabled = false;
                    this.cancelReadDataButton.disabled = true;
                    this._hideProgressBar();
                    this.garminController.cancelReadFromDevice();
                }.bind(this)
                        
                this.readDataButton.disabled = false;
                this.readDataButton.onclick = function() {
                    this.readDataButton.disabled = true;
                    this.cancelReadDataButton.disabled = false;
                    this._showProgressBar();
                    this.garminController.readFromDevice();
                }.bind(this)

            } else {
                this._setStatus("No devices found.");
            }
        },

        onStartFindDevices: function(json) {
            this._setStatus("Looking for connected Garmin devices");
        },

        onCancelFindDevices: function(json) {
            this._setStatus("Find cancelled");
        },

        onProgressReadFromDevice: function(json) {
            this._updateProgressBar(json.progress.getPercentage());
            this._setStatus(json.progress);
        },
    
        onCancelReadFromDevice: function(json) {
            this._setStatus("Read cancelled");
        },

        onFinishReadFromDevice: function(json) {
            this.readDataButton.disabled = false;
            this.cancelReadDataButton.disabled = true;
            this._hideProgressBar();
            this._setStatus("Data read from device.");

            var gpsData = json.controller.gpsData;
        	console.log(gpsData);
            this._setStatus("Parsing track data...");
            var factory = new Garmin.GpsDataFactory();
            factory.parseGpxDocument(gpsData);
            this.tracks = factory.getTracks();
        	console.log(tracks);
            this.waypoints = factory.getWaypoints();
        	console.log(waypoints);
            this._setStatus(this.tracks.length + " tracks and " + this.waypoints.length + " waypoints found");
        
            this._listTracks(this.tracks);
            this._listWayPoints(this.waypoints);
        },
    
        ////////////////////////////////////////////////////////////////////////
        //internal utility methods:

        _intializeController: function() {
            try {
                this.garminController = new Garmin.DeviceControl();
                this.garminController.unlock("http://mydomain.com","pasteYourKeyInHere");
                this.garminController.register(this);
            } catch (e) {
                this._setStatus(e.message);
            }
        },

        _showProgressBar: function() {
            Element.show(this.progressBar);
        },

        _hideProgressBar: function() {
            Element.hide(this.progressBar);
        },

        _updateProgressBar: function(value) {
            var percent = (value <= 100) ? value : 100;
            this.progressBarDisplay.style.width = percent + "%";
        },

        _listDevices: function(devices) {
            for( var i=0; i < devices.length; i++ ) {
                this.deviceSelect.options[i] = new Option(devices[i].getDisplayName(),devices[i].getNumber());
                if(devices[i].getNumber() == this.garminController.deviceNumber) {
                    this.deviceSelect.selectedIndex = i;
                    this._showDeviceInfo(devices[i]);
                }
            }
            this.deviceSelect.onchange = function() {
                var device = this.garminController.getDevices()[this.deviceSelect.value];
                this.showDeviceInfo(device);
                this.garminController.setDeviceNumber(this.deviceSelect.value);
            }.bind(this)
            this.deviceSelect.disabled = false;
        },

        _showDeviceInfo: function(device) {
            this.deviceInfo.innerHTML = "Part Number:\t\t" + device.getPartNumber() + "\n";
            this.deviceInfo.innerHTML += "Software Version:\t" + device.getSoftwareVersion() + "\n";
            this.deviceInfo.innerHTML += "Description:\t\t" + device.getDescription() + "\n";
            this.deviceInfo.innerHTML += "Id:\t\t\t" + device.getId();
        },

        _listTracks: function(tracks) {
            this._clearTracks();
            for( var i=0; i < tracks.length; i++ ) {
                var trk = tracks[i];
                if(trk.isDrawable()) {
                    this.readTracksSelect.options[i] = new Option(trk.getStartDate() + " - (" + trk.getDuration() + ")",i);
                }
            }
            this._displayTrack(tracks[this.readTracksSelect.selectedIndex]);
            this.readTracksSelect.onchange = function() {
                var trk = this.tracks[this.readTracksSelect.selectedIndex];
                this._displayTrack(trk);
            }.bind(this)
            this.readTracksSelect.disabled = false;
        },
    
        _listWayPoints: function(waypoints) {
            this._clearWayPoints();
            for( var i=0; i < waypoints.length; i++ ) {
                var wpt = waypoints[i];
                this.readWaypointsSelect.options[i] = new Option(wpt.getName(),i);
            }
            this.readWaypointsSelect.onchange = function() {
                var wpt = this.waypoints[this.readWaypointsSelect.selectedIndex];
                this._displayWayPoint(wpt);
            }.bind(this)
            this.readWaypointsSelect.disabled = false;
        },
    
        _clearTracks: function() {
            for( var i=0; i < this.readTracksSelect.options.length; i++ ) {
                this.readTracksSelect.options[i] = null;
            }
        },

        _clearWayPoints: function() {
            for( var i=0; i < this.readWaypointsSelect.options.length; i++ ) {
                this.readWaypointsSelect.options[i] = null;
            }
        },

        _displayTrack: function(track) {
            this.mc.map.clearOverlays();
            this.mc.centerAndScale(track.getStartLat(), track.getStartLng());
            this.mc.addTrack(track);
        },

        _displayWayPoint: function(wpt) {
            this.mc.map.clearOverlays();
            this.mc.centerAndScale(wpt.getLat(), wpt.getLng());
            this.mc.addWayPoint(wpt);
        },

        _setStatus: function(statusText) {
            this.status.innerHTML = statusText;
        }
    };

    //display is created when HTML page is loaded
    var display;
        
    function load() {
        display = new GarminDeviceControlDemo("statusText", "readMap");
    }
</script>

<body onload="load()">

	<object id="GarminActiveXControl"
		style="WIDTH: 0px; HEIGHT: 0px; visible: hidden" height="0" width="0"
		classid="CLSID:099B5A62-DE20-48C6-BF9E-290A9D1D8CB5">
		<object id="GarminNetscapePlugin"
			type="application/vnd-garmin.mygarmin" width="0" height="0">
		</object>
	</object>

	<h2>Overlay Track Data on a Google Map</h2>

	<div id="actionStatus">
		<div id="statusText">Status Text</div>

		<div id="progressBar" style="display: none;" align="left">
			<div id="progressWrapper">
				<div id="progressBarDisplay">&#160;</div>
			</div>
		</div>
	</div>

	<div id="deviceBox">
		<input type="button" value="Find Devices" id="findDevicesButton"
			disabled="true" /> <input type="button" value="Cancel Find Devices"
			id="cancelFindDevicesButton" disabled="true" /> <br /> <select
			name="deviceSelect" id="deviceSelect" disabled="true">
			<option value="-1">No Devices Found</option>
		</select> <br />
		<textarea id="deviceInfoText" rows="3" cols="60"></textarea>
	</div>

	<div id="readBox">
		<input type="button" value="Read From Device" id="readDataButton"
			disabled="true" /> <input type="button"
			value="Cancel Read From Device" id="cancelReadDataButton"
			disabled="true" /> <br /> <select name="readTracksSelect"
			id="readTracksSelect" disabled="true">
			<option value="-1">No Tracks Found</option>
		</select> <select name="readWaypointsSelect" id="readWaypointsSelect"
			disabled="true">
			<option value="-1">No Waypoints Found</option>
		</select>
		<div id="readMap" style="width: 400px; height: 400px;">&#160;</div>
	</div>

</body>
</html>